import { useCookie, useNuxtApp, useRuntimeConfig } from "#app";
import { computed } from "vue";
import { useDirectusUrl } from "./useDirectusUrl.mjs";
export const useDirectusToken = () => {
  const nuxtApp = useNuxtApp();
  const baseUrl = useDirectusUrl();
  const config = useRuntimeConfig().public;
  const token = () => {
    nuxtApp._cookies = nuxtApp._cookies || {};
    if (nuxtApp._cookies[config.directus.cookieNameToken]) {
      return nuxtApp._cookies[config.directus.cookieNameToken];
    }
    const cookie = useCookie(config.directus.cookieNameToken);
    nuxtApp._cookies[config.directus.cookieNameToken] = cookie;
    return cookie;
  };
  const refreshToken = () => {
    nuxtApp._cookies = nuxtApp._cookies || {};
    if (nuxtApp._cookies[config.directus.cookieNameRefreshToken]) {
      return nuxtApp._cookies[config.directus.cookieNameRefreshToken];
    }
    const cookie = useCookie(config.directus.cookieNameRefreshToken, { maxAge: config.directus.maxAgeRefreshToken });
    nuxtApp._cookies[config.directus.cookieNameRefreshToken] = cookie;
    return cookie;
  };
  const expires = () => {
    nuxtApp._cookies = nuxtApp._cookies || {};
    if (nuxtApp._cookies.directus_token_expired_at) {
      return nuxtApp._cookies.directus_token_expired_at;
    }
    const cookie = useCookie("directus_token_expired_at");
    nuxtApp._cookies.directus_token_expired_at = cookie;
    return cookie;
  };
  const refreshTokens = async () => {
    if (refreshToken() && refreshToken().value) {
      const body = {
        refresh_token: refreshToken().value
      };
      const data = await $fetch("/auth/refresh", {
        baseURL: baseUrl,
        body,
        method: "POST"
      });
      expires().value = (/* @__PURE__ */ new Date()).getTime() + data.data.expires;
      token().value = data.data.access_token;
      refreshToken().value = data.data.refresh_token;
      return data.data;
    } else {
      return null;
    }
  };
  const token_expires_in = computed(() => Math.max(0, (expires().value ?? 0) - (/* @__PURE__ */ new Date()).getTime()));
  const token_expired = computed(() => !token().value || token_expires_in.value === 0);
  const checkAutoRefresh = async () => {
    if (config.directus.autoRefresh) {
      if (token_expired.value) {
        try {
          await refreshTokens();
        } catch (e) {
          refreshToken().value = null;
          if (config.directus.onAutoRefreshFailure) {
            await config.directus.onAutoRefreshFailure();
          }
        }
      }
    }
  };
  return {
    token: token(),
    refreshToken: refreshToken(),
    expires: expires(),
    token_expires_in,
    token_expired,
    refreshTokens,
    checkAutoRefresh
  };
};
